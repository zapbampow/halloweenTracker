<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒ Halloween Stats - Trick-or-Treater Activity</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="stats.css">
</head>

<body>
    <a href="/" class="nav-link">ğŸƒ Back to Counter</a>

    <button class="refresh-btn" onclick="loadStats()">
        ğŸ”„ Refresh
    </button>

    <div class="header">
        <div class="title">Halloween Activity Stats</div>
        <div class="subtitle">Trick-or-Treater Traffic Per Minute</div>

        <div class="view-toggle">
            <button class="view-btn active" onclick="switchView('line')" data-view="line">ğŸ“ˆ Line Chart</button>
            <button class="view-btn" onclick="switchView('bar')" data-view="bar">ğŸ“Š Bar Chart</button>
            <button class="view-btn" onclick="switchView('timeline')" data-view="timeline">â° Timeline</button>
        </div>
    </div>

    <div class="stats-container">
        <div id="loading" class="loading htmx-indicator">Loading spooky data</div>
        <div id="stats-content">
            <!-- Stats will be loaded here -->
        </div>
    </div>

    <!-- Settings Button and Menu -->
    <div class="settings-container">
        <button class="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-header">ğŸƒ Settings</div>
            <button class="settings-option reset-btn" onclick="resetCount()">
                ğŸ”„ Reset Count for New Night
            </button>
            <div class="settings-warning">
                âš ï¸ This will delete all records!
            </div>
        </div>
    </div>

    <script>
        let currentView = 'line';
        let currentData = [];

        // Function to switch views
        function switchView(view) {
            currentView = view;

            // Update active button
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');

            // Re-render with current data
            if (currentData.length > 0) {
                document.getElementById('stats-content').innerHTML = renderChart(currentData);
            }
        }

        // Function to render line chart
        function renderLineChart(data) {
            const maxCount = Math.max(...data.map(d => d.count));
            const chartWidth = Math.max(800, data.length * 40);

            // Create SVG points for the line
            const points = data.map((item, index) => {
                const x = (index / (data.length - 1)) * 100;
                const y = maxCount > 0 ? 100 - (item.count / maxCount) * 80 : 100;
                return `${x},${y}`;
            }).join(' ');

            // Create area fill points
            const areaPoints = `0,100 ${points} 100,100`;

            return `
                <div class="line-chart-container" style="width: ${chartWidth}px;">
                    <svg class="line-chart" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:0.6"/>
                                <stop offset="100%" style="stop-color:#ff3030;stop-opacity:0.1"/>
                            </linearGradient>
                        </defs>
                        <polygon points="${areaPoints}" fill="url(#areaGradient)"/>
                        <polyline points="${points}" fill="none" stroke="#ff3030" stroke-width="0.5" class="line"/>
                    </svg>
                    <div class="line-chart-labels">
                        ${data.map((item, index) => `
                            <div class="line-label" style="left: ${(index / (data.length - 1)) * 100}%">
                                <div class="line-time">${item.time}</div>
                                <div class="line-count">${item.count}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Function to render timeline view
        function renderTimeline(data) {
            const maxCount = Math.max(...data.map(d => d.count));

            return `
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="timeline-start">${data[0]?.time || 'Start'}</div>
                        <div class="timeline-end">${data[data.length - 1]?.time || 'Now'}</div>
                    </div>
                    <div class="timeline">
                        ${data.map((item, index) => {
                const intensity = maxCount > 0 ? Math.max(0.1, item.count / maxCount) : 0.1;
                const size = 20 + (intensity * 30);
                return `
                                <div class="timeline-event" style="
                                    left: ${(index / (data.length - 1)) * 100}%; 
                                    opacity: ${0.3 + intensity * 0.7};
                                    width: ${size}px;
                                    height: ${size}px;
                                " title="${item.time}: ${item.count} visitors">
                                    <div class="event-pulse"></div>
                                    <div class="event-label">
                                        <div class="event-time">${item.time}</div>
                                        <div class="event-count">${item.count}</div>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
        }

        // Function to render bar chart (improved version)
        function renderBarChart(data) {
            const maxCount = Math.max(...data.map(d => d.count));

            const chartHTML = data.map((item, index) => {
                const height = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
                return `
                    <div class="bar-container">
                        <div class="bar" style="height: ${height}%">
                            <div class="bar-value">${item.count}</div>
                        </div>
                        <div class="bar-label">${item.time}</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="chart-container">
                    <div class="chart">
                        ${chartHTML}
                    </div>
                </div>
            `;
        }

        // Main render function
        function renderChart(data) {
            if (!data || data.length === 0) {
                return `
                    <div class="no-data">
                        ğŸ‘» No trick-or-treaters yet! 
                        <br><small>Start counting to see the spooky stats!</small>
                    </div>
                `;
            }

            currentData = data;

            // Calculate summary stats
            const maxCount = Math.max(...data.map(d => d.count));
            const totalCount = data.reduce((sum, d) => sum + d.count, 0);
            const peakTime = data.find(d => d.count === maxCount)?.time || 'N/A';
            const activeMinutes = data.filter(d => d.count > 0).length;

            let chartHTML = '';

            switch (currentView) {
                case 'line':
                    chartHTML = renderLineChart(data);
                    break;
                case 'timeline':
                    chartHTML = renderTimeline(data);
                    break;
                case 'bar':
                default:
                    chartHTML = renderBarChart(data);
                    break;
            }

            return `
                ${chartHTML}
                
                <div class="summary">
                    <div class="summary-card">
                        <div class="summary-value">${totalCount}</div>
                        <div class="summary-label">Total Visitors</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${maxCount}</div>
                        <div class="summary-label">Peak Count</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${peakTime}</div>
                        <div class="summary-label">Peak Time</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${activeMinutes}</div>
                        <div class="summary-label">Active Minutes</div>
                    </div>
                </div>
            `;
        }

        // Function to load stats data
        function loadStats() {
            const loadingElement = document.getElementById('loading');
            const statsContent = document.getElementById('stats-content');

            loadingElement.style.display = 'block';

            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    statsContent.innerHTML = renderChart(data);
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    loadingElement.style.display = 'none';
                    statsContent.innerHTML = `
                        <div class="no-data">
                            ğŸ’€ Error loading stats! 
                            <br><small>Try refreshing the page</small>
                        </div>
                    `;
                });
        }

        // Settings menu functionality
        function toggleSettings() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
        }

        // Reset count functionality
        function resetCount() {
            if (confirm('ğŸƒ Are you sure you want to reset the count?\n\nğŸ‘» This will delete ALL trick-or-treater records and start fresh for a new Halloween night!\n\nğŸ’€ This action cannot be undone!')) {
                fetch('/api/reset', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Reload stats to show empty state
                    loadStats();
                    
                    // Hide settings menu
                    const menu = document.getElementById('settingsMenu');
                    menu.classList.remove('show');
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'reset-success';
                    successMsg.innerHTML = 'âœ… All records reset! Ready for new trick-or-treaters! ğŸƒ';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error resetting count:', error);
                    alert('âŒ Failed to reset records. Please try again.');
                });
            }
        }

        // Close settings menu when clicking outside
        document.addEventListener('click', function(event) {
            const settingsContainer = document.querySelector('.settings-container');
            if (!settingsContainer.contains(event.target)) {
                document.getElementById('settingsMenu').classList.remove('show');
            }
        });

        // Load stats when page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
        });
    </script>
</body>

</html>
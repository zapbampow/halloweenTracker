<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÉ Halloween Stats - Trick-or-Treater Activity</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="stats.css">
</head>

<body>
    <a href="/" class="nav-link">üéÉ Back to Counter</a>

    <button class="refresh-btn" onclick="loadStats()">
        üîÑ Refresh
    </button>

    <div class="header">
        <div class="title">Halloween Activity Stats</div>
        <div class="subtitle">Trick-or-Treater Traffic Per Minute</div>
    </div>

    <div class="stats-container">
        <div id="loading" class="loading htmx-indicator">Loading spooky data</div>
        <div id="stats-content">
            <!-- Stats will be loaded here -->
        </div>
    </div>

    <!-- Settings Button and Menu -->
    <div class="settings-container">
        <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        <div class="settings-menu" id="settingsMenu">
            <div class="settings-header">üéÉ Settings</div>
            <button class="settings-option reset-btn" onclick="resetCount()">
                üîÑ Reset Count for New Night
            </button>
            <div class="settings-warning">
                ‚ö†Ô∏è This will delete all records!
            </div>
        </div>
    </div>

    <script>
        let currentData = [];

        // Function to render bar chart
        function renderBarChart(data) {
            const maxCount = Math.max(...data.map(d => d.count));

            // Determine if we should show every label or every 10th
            const showEvery10th = data.length > 20;

            const chartHTML = data.map((item, index) => {
                const height = maxCount > 0 ? (item.count / maxCount) * 100 : 0;

                // Show label only if we're showing all labels OR if this is every 10th minute
                const showLabel = !showEvery10th || (index % 10 === 0);

                return `
                    <div class="bar-container">
                        <div class="bar" style="height: ${height}%" 
                             onmouseenter="showTooltip(event, '${item.time}', ${item.count})"
                             onmouseleave="hideTooltip()"
                             onmousemove="moveTooltip(event)">
                            <div class="bar-value">${item.count}</div>
                        </div>
                        ${showLabel ? `<div class="bar-label">${item.time}</div>` : '<div class="bar-label"></div>'}
                    </div>
                `;
            }).join('');

            return `
                <div class="chart-container">
                    <div class="chart">
                        ${chartHTML}
                    </div>
                    <div id="tooltip" class="tooltip"></div>
                </div>
            `;
        }

        // Main render function
        function renderChart(data) {
            if (!data || data.length === 0) {
                return `
                    <div class="no-data">
                        üëª No trick-or-treaters yet! 
                        <br><small>Start counting to see the spooky stats!</small>
                    </div>
                `;
            }

            currentData = data;

            // Calculate summary stats
            const maxCount = Math.max(...data.map(d => d.count));
            const totalCount = data.reduce((sum, d) => sum + d.count, 0);
            const peakTime = data.find(d => d.count === maxCount)?.time || 'N/A';
            const activeMinutes = data.filter(d => d.count > 0).length;

            const chartHTML = renderBarChart(data);

            return `
                ${chartHTML}
                
                <div class="summary">
                    <div class="summary-card">
                        <div class="summary-value">${totalCount}</div>
                        <div class="summary-label">Total Visitors</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${maxCount}</div>
                        <div class="summary-label">Peak Count</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${peakTime}</div>
                        <div class="summary-label">Peak Time</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${activeMinutes}</div>
                        <div class="summary-label">Active Minutes</div>
                    </div>
                </div>
            `;
        }

        // Function to load stats data
        function loadStats() {
            const loadingElement = document.getElementById('loading');
            const statsContent = document.getElementById('stats-content');

            loadingElement.style.display = 'block';

            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    loadingElement.style.display = 'none';
                    statsContent.innerHTML = renderChart(data);
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    loadingElement.style.display = 'none';
                    statsContent.innerHTML = `
                        <div class="no-data">
                            üíÄ Error loading stats! 
                            <br><small>Try refreshing the page</small>
                        </div>
                    `;
                });
        }

        // Settings menu functionality
        function toggleSettings() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
        }

        // Reset count functionality
        function resetCount() {
            if (confirm('üéÉ Are you sure you want to reset the count?\n\nüëª This will delete ALL trick-or-treater records and start fresh for a new Halloween night!\n\nüíÄ This action cannot be undone!')) {
                fetch('/api/reset', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Reload stats to show empty state
                        loadStats();

                        // Hide settings menu
                        const menu = document.getElementById('settingsMenu');
                        menu.classList.remove('show');

                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'reset-success';
                        successMsg.innerHTML = '‚úÖ All records reset! Ready for new trick-or-treaters! üéÉ';
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            successMsg.remove();
                        }, 3000);
                    })
                    .catch(error => {
                        console.error('Error resetting count:', error);
                        alert('‚ùå Failed to reset records. Please try again.');
                    });
            }
        }

        // Tooltip functionality
        function showTooltip(event, time, count) {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) {
                tooltip.innerHTML = `
                    <div class="tooltip-time">${time}</div>
                    <div class="tooltip-count">${count} visitor${count === 1 ? '' : 's'}</div>
                `;
                tooltip.style.display = 'block';
                moveTooltip(event);
            }
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        function moveTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) {
                const offsetX = 10;
                const offsetY = -10;
                tooltip.style.left = (event.clientX + offsetX) + 'px';
                tooltip.style.top = (event.clientY + offsetY) + 'px';
            }
        }

        // Close settings menu when clicking outside
        document.addEventListener('click', function (event) {
            const settingsContainer = document.querySelector('.settings-container');
            if (!settingsContainer.contains(event.target)) {
                document.getElementById('settingsMenu').classList.remove('show');
            }
        });

        // Load stats when page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
        });
    </script>
</body>

</html>